import urllib
import zipfile
import os
import shutil
from dataget.utils import get_file
from dataget.api import register_dataset
from multiprocessing import Pool
from dataget.dataset import ImageNavigationDataSet


URL = "https://d17h27t6h515a5.cloudfront.net/topher/2016/December/584f6edd_data/data.zip"

@register_dataset
class UdacitySelfdrivingSimulator(ImageNavigationDataSet):

    @property
    def _raw_extension(self):
        return "jpg"

    @property
    def help(self):
        return "TODO"

    def reqs(self, **kwargs):
        return super(UdacitySelfdrivingSimulator, self).reqs() + " odo"


    def _download(self, **kwargs):
        get_file(URL, self.path, "dataset.zip")

    def _extract(self, **kwargs):
        from odo import odo
        from pandas import DataFrame
        import pandas as pd

        print("Extracting zip")
        with zipfile.ZipFile(os.path.join(self.path,"dataset.zip"), 'r') as zip_ref:
            zip_ref.extractall(self.path)

        print("Moving data")
        os.path.join(self.path, "data", "IMG") |> shutil.move$(?, self.path)
        os.path.join(self.path, "data", "driving_log.csv") |> shutil.move$(?, self.path)

        print("Removing folders")
        os.path.join(self.path, "__MACOSX") |> shutil.rmtree
        os.path.join(self.path, "data") |> shutil.rmtree

        df = odo("../../.dataget/data/udacity-selfdriving-simulator/driving_log.csv", DataFrame, dshape =
            'var * {center: string, left: string, right: string, steering: float64, throttle: float64, brake: float64, speed: float64}'
        )

        df_L = df.copy()
        df_C = df.copy()
        df_R = df.copy()

        df_L["camera"] = 0
        df_C["camera"] = 1
        df_R["camera"] = 2

        df_L["filename"] = df_L["left"]
        df_C["filename"] = df_C["center"]
        df_R["filename"] = df_R["right"]

        df_L = df_L.drop(["left", "center", "right"], axis = 1)
        df_C = df_C.drop(["left", "center", "right"], axis = 1)
        df_R = df_R.drop(["left", "center", "right"], axis = 1)

        df = pd.concat([df_L, df_C, df_R])

        

        os.getcwd()
